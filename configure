#!/bin/bash

#
# NOTE: We're assuming Ubuntu for now
#

if [[ ! -d .git ]]
then
    # Assume this is a package build
    # config.mk should already be generated
    if [[ ! -d "kernel" ]]
    then
        echo "Kernel directory is missing! Build will fail."
        exit 1
    fi
    if [[ ! -f "config.mk" ]]
    then
        echo "config.mk is missing! Build will fail."
        exit 1
    fi
    exit 0
fi

SOURCE="/usr/src/linux-source-$(uname -r | cut -d'-' -f1).tar.bz2"

if [[ ! -d "./kernel" ]]; then
    if [[ ! -f "${SOURCE}" ]]; then
        echo "Missing linux kernel source ${SOURCE}."
        echo "Try: sudo apt install linux-source-$(uname -r | cut -d'-' -f1)"
        exit 1
    fi

    mkdir -p ./kernel
    echo "Extracting kernel (this takes a minute or so)"
    tar -jxf "${SOURCE}" -C ./kernel --strip-components=1
fi

if quilt unapplied; then
    # Apply patches
    if ! quilt push -a; then
        echo "Patch failed to apply. Use \"quilt push -a -f\" and then reconcile the *.rej files"
        echo "Then update the patch with \"quilt refresh\" followed by \"quilt pop -a\""
        echo "Make sure to \"quilt add <path>\" for any new files that may need to be patched before"
        echo "making any changes to those files."
        exit 1
    fi
fi

truncate -s0 config.mk
echo "KERNEL_CONFIG_FILE=/boot/config-$(uname -r)" >> config.mk
echo "KERNEL_SYMVERS_FILE=/usr/src/linux-headers-$(uname -r)/Module.symvers" >> config.mk
echo "PATCH_VERSION=" >> config.mk
echo "INSTALL_DIR=/lib/modules/$(uname -r)/updates/introvirt/" >> config.mk

rm -f debian/*.install debian/*.postinst

cp -f debian/kvm-introvirt.install.tpl "debian/kvm-introvirt-$(uname -r).install"
cp -f debian/kvm-introvirt.postinst.tpl "debian/kvm-introvirt-$(uname -r).postinst"

#sed -i "s/[0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+\.[0-9]\+/$KERNEL_VERSION_FULL/g" debian/changelog
#sed -i "s/[0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+$KERNEL_FLAVOR/$KERNEL_VERSION$KERNEL_FLAVOR/g" debian/control
#sed -i "s/[0-9]\+\.[0-9]\+\.[0-9]\+-[0-9]\+$KERNEL_FLAVOR/$KERNEL_VERSION$KERNEL_FLAVOR/g" debian/*.postinst

exit 0
