#!/bin/bash

#
# NOTE: We're assuming Ubuntu and HWE for now
#
KERNEL_VERSION_FULL="$(uname -r)"
LSB_RELEASE=$(lsb_release -sr)
LSB_CODENAME=$(lsb_release -sc)
PATCH_DIR="ubuntu/$(lsb_release -sc)/hwe/$(uname -r)"
PATCH_VERSION="1.0.0"
EMAIL="${DEBEMAIL:=laplantes@ainfosec.com}"
FULLNAME="${DEBFULLNAME:=Sean LaPlante}"

if [[ ! -d ${PATCH_DIR} ]]; then
    echo "No patch for $(uname -r)".
    echo "Make the ${PATCH_DIR} directory and copy most recent patch files over to start working on the patch."
    exit 1
fi

pushd ${PATCH_DIR} > /dev/null

if [[ ! -d "./kernel" ]]; then
    echo "Getting kernel source. This could take a bit..."
    apt source linux-image-unsigned-$(uname -r)
    mv linux*$(uname -r | cut -d- -f 1)/ kernel
    rm -f linux*.dsc linux*.tar.gz linux*.diff.gz
fi

if quilt unapplied; then
    # Apply patches
    if ! quilt push -a; then
        echo "Patch failed to apply. Use \"quilt push -a -f\" and then reconcile the *.rej files"
        echo "Then update the patch with \"quilt refresh\" followed by \"quilt pop -a\""
        echo "Make sure to \"quilt add <path>\" for any new files that may need to be patched before"
        echo "making any changes to those files."
        popd > /dev/null
        exit 1
    fi
fi
popd > /dev/null

# Create the config.mk file
truncate -s0 config.mk
echo "WORKING_DIR=${PATCH_DIR}" >> config.mk
echo "KERNEL_CONFIG_FILE=/boot/config-$(uname -r)" >> config.mk
echo "KERNEL_SYMVERS_FILE=/usr/src/linux-headers-$(uname -r)/Module.symvers" >> config.mk
echo "PATCH_VERSION=${PATCH_VERSION}" >> config.mk
echo "INSTALL_DIR=/lib/modules/$(uname -r)/updates/introvirt/" >> config.mk
echo "DEB_NAME=kvm-introvirt-${KERNEL_VERSION_FULL}.${LSB_RELEASE}-${PATCH_VERSION}.deb" >> config.mk
echo "KERNEL_VERSION_FULL=${KERNEL_VERSION_FULL}" >> config.mk

rm -f debpkg/DEBIAN/postinst debpkg/DEBIAN/postrm debpkg/DEBIAN/preinst
cp -f debpkg/DEBIAN/postinst.tpl debpkg/DEBIAN/postinst
cp -f debpkg/DEBIAN/preinst.tpl debpkg/DEBIAN/preinst
cp -f debpkg/DEBIAN/postrm.tpl debpkg/DEBIAN/postrm

# Update the debian control and post install files
sed -i "s/KERNEL_VERSION_FULL=\"<<<REPLACED_BY_CONFIGURE>>>\"/KERNEL_VERSION_FULL=\"${KERNEL_VERSION_FULL}\"/g" debpkg/DEBIAN/postinst
sed -i "s/KERNEL_VERSION_FULL=\"<<<REPLACED_BY_CONFIGURE>>>\"/KERNEL_VERSION_FULL=\"${KERNEL_VERSION_FULL}\"/g" debpkg/DEBIAN/preinst
sed -i "s/KERNEL_VERSION_FULL=\"<<<REPLACED_BY_CONFIGURE>>>\"/KERNEL_VERSION_FULL=\"${KERNEL_VERSION_FULL}\"/g" debpkg/DEBIAN/postrm
sed -i "s/[0-9]\+\.[0-9]\+\.[0-9]\+\-[0-9]\+-[a-z]\+"/${KERNEL_VERSION_FULL}/g debpkg/DEBIAN/control

# Build the changelog
truncate -s0 debpkg/DEBIAN/changelog
cat << EOF > debpkg/DEBIAN/changelog
kvm-introvirt (${KERNEL_VERSION_FULL}.${LSB_RELEASE}-${PATCH_VERSION}~${LSB_CODENAME}1) ${LSB_CODENAME}; urgency=medium

  * kvm-introvirt patch ${PATCH_VERSION} for ${KERNEL_VERSION_FULL}

 -- ${FULLNAME} <${EMAIL}>  $(date -u)
EOF

exit 0
